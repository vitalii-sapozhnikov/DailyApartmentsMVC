@model List<DailyApartmentsMVC.Models.GuestModel.PropertyDetails>
@{
    ViewData["Title"] = "Details";
    int propertyId = int.Parse(ViewBag.Id);
}


@if (TempData.ContainsKey("showToast") && TempData["showToast"] is bool success && success)
{
    <div id="toast-container" class="toast show" role="alert" aria-live="assertive" aria-atomic="true" data-delay="0" data-autohide="false">
        <div class="toast-header bg-success">
            <strong class="me-auto" style="color: #FFF;">Ви здійснили бронювання!</strong>
            <button type="button" class="btn-close ms-2 mb-1" data-bs-dismiss="toast" aria-label="Close">
                <span aria-hidden="true"></span>
            </button>
        </div>
        <div class="toast-body bg-light">
            Очікуйте, поки власник розгляне ваш запит
        </div>
    </div>
}

<script>
    $(function () {
        $('.toast').toast('show');
    });
</script>





<div class="container mt-4" style="max-width: 1200px;">
    <a class="btn btn-light btn-sm" href="javascript:history.back()">
        <span><</span><span class="mx-2">Назад</span>
    </a>
    <div class="row">
        <div class="col-8 pl-5">
            @*CAROUSEL*@
            <div id="carouselExampleIndicators" class="carousel slide mt-4 mx-auto" data-bs-ride="true">
                <div class="carousel-indicators">
                    @for (int i = 0; i < Model.First().PhotoLinks.Count(); i++)
                    {
                        string tmp = i == 0 ? "active" : "";
                        <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="@i" class="@tmp" aria-current="true" aria-label="Slide @i"></button>
                    }
                </div>
                <div class="carousel-inner">
                    @for (int i = 0; i < Model.First().PhotoLinks.Count(); i++)
                    {
                        string tmp = i == 0 ? "active" : "";
                        <div class="carousel-item @tmp">
                            <img src="@Model.First().PhotoLinks[i]" class="d-block w-100" alt="@i">
                        </div>
                    }
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>

            <div class="details-text mt-4 p-4" style="background-color: #FFFFFF;">
                <p class="text-muted">Опубліковано @Model.First().PublicationDate.ToString("D")</p>
                <h2 class="">@Model.First().Title</h2>

                <h1 class="mt-4 fw-bolder text-success">$ @Model.First().Price</h1>

                <h5 class="mt-4">ОПИС</h5>

                <p>@Model.First().Description</p>

            </div>

            <div class="mt-4 p-4" style="background-color: #FFFFFF;">
                <h5 class="mt-1 mb-4">ВІДГУКИ</h5>
                @{
                    var comments = Model.Where(c => c.Comment != null)
                    .Select(m => new { m.Comment, m.ReviewGuestName, m.ReviewGuestSurname })
                    .Distinct();
                }
                @if (comments.Count() == 0)
                {
                    <p>Немає жодного відгуку</p>
                }
                else
                {
                    foreach (var c in comments)
                    {
                        <hr />
                        <figure class="mb-3">
                            <blockquote class="blockquote">
                                <p class="mb-0" style="font-size: 0.9em;">@c.Comment</p>
                            </blockquote>
                            <figcaption class="blockquote-footer mt-1">
                                <cite title="Source Title">@c.ReviewGuestName @c.ReviewGuestSurname</cite>
                            </figcaption>
                        </figure>
                    }
                }
            </div>
        </div>
        <div class="col-4">
            <div class="mt-4 p-3" style="background-color: #FFFFFF;">
                <h6 class="text-muted">КОРИСТУВАЧ</h6>
                <h5 class="mt-3">@Model.First().OwnerName @Model.First().OwnerSurname</h5>
                @{
                    long deals = @Model.First().Deals ?? 0;
                }
                <p class="mt-2 text-success">@deals успішних угод</p>
            </div>

            <div class="mt-2 p-3" style="background-color: #FFFFFF;">
                <h6 class="text-muted mb-3">РЕЙТИНГ</h6>
                @{
                    var groupedRatings = @Model
                    .GroupBy(r => r.RatingAttribute)
                    .Select(g => new
                    {
                        Category = g.Key,
                        AverageRating = g.Average(r => r.Rating)
                    }).ToList();
                }
                @if (@Model.Count == 1)
                {
                    <p>Немає жодного відгуку</p>
                }
                else
                {
                    <table>
                        @foreach (var rating in groupedRatings.Take(groupedRatings.Count() - 1))
                        {
                            if (rating.AverageRating != null)
                            {
                                <tr>
                                    <td>@rating.Category:</td>
                                    <td style="padding-left: 1.5rem;">
                                        @String.Format("{0:0.0}", rating.AverageRating)
                                        @for (int j = 0; j < (int)rating.AverageRating; j++)
                                        {
                                            <span style="font-size: 1rem; letter-spacing: -0.35rem;">🟊</span>
                                        }
                                    </td>
                                </tr>
                            }
                        }
                    </table>
                }
            </div>

            <div class="mt-2 p-3" style="background-color: #FFFFFF;">
                <h6 class="text-muted">МІСЦЕЗНАХОДЖЕННЯ</h6>
                <div class="d-flex align-items-center">
                    <img src="https://i.ibb.co/zPpxgwp/image-2023-04-08-21-01-19.png" width="25" />
                    <p class="mt-3" style="margin-left: 2em;">
                        @Model.First().Country, @Model.First().City, вул. @Model.First().Street,
                        @Model.First().House
                    </p>
                </div>
            </div>

            <div class="mt-2 p-3" style="background-color: #FFFFFF;">
                <h6 class="text-muted">ДЕТАЛІ</h6>
                <div class="mt-3">
                    <p style="margin-bottom: 0;">Кількість кімнат: @Model.First().RoomNumber</p>
                    <p class="mt-1" style="margin-bottom: 0;">Кількість спальних місць: @Model.First().SleepingPlaceNumber</p>
                </div>
            </div>

            <div class="mt-2 p-3" style="background-color: #FFFFFF;">
                <a class="btn btn-success w-100" data-bs-toggle="modal" data-bs-target="#createBooking">забронювати</a>



                <div class="modal fade" id="createBooking" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="exampleModalLabel">Підтвердження бронювання</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>

                            <div class="modal-body">

                                <div class="form-group mb-3">
                                    <label>Місцезнаходження</label>
                                    <input type="text" class="form-control" readonly value="@Model.First().Country, @Model.First().City, @Model.First().Street @Model.First().House" />
                                </div>

                                <div class="form-group mb-3 d-flex justify-content-between">
                                    <div>
                                        <label>Кількість кімнат</label>
                                        <input type="number"
                                               readonly
                                               class="form-control"
                                               value="@Model.First().RoomNumber">
                                    </div>
                                    <div>
                                        <label>Спальних місць</label>
                                        <input type="number"
                                               readonly
                                               class="form-control"
                                               value="@Model.First().SleepingPlaceNumber">
                                    </div>
                                </div>

                                <form method="post" asp-route-id="@propertyId" asp-action="CreateBooking">
                                    @*Date Range*@
                                    <div class="form-group mb-3">
                                        <label>Дата заїзду:</label>
                                        <div class="input-group date-range">
                                            <input type="text"
                                                   class="form-control date-range"
                                                   id="daterange"
                                                   name="daterange"
                                                   value="@TempData["DateRange"]">
                                        </div>
                                    </div>


                                    @if (TempData.ContainsKey("Error") && TempData["Error"] is string str)
                                    {
                                        <p class="text-danger">@str</p>
                                    }

                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Назад</button>
                                    <button type="submit" id="create-booking-btn" class="btn btn-success">Бронювати</button>


                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


</div>



@if (TempData.ContainsKey("Error"))
{
    <script>
        $(function () {
            $('#createBooking').modal('show');
        });
    </script>
}
